{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{% static 'css/global-styles.css' %}">
    
    <style>
        /* Contenedor principal del formulario */
        .adminage-form-container { 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 30px; 
            background: #1e1e1e; /* Fondo ligeramente m√°s claro que el body */
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* Sombra suave para destacar */
        }
        
        /* Mensajes de Django */
        .adminage-messages { 
            list-style: none; 
            padding: 15px; 
            border-radius: 4px; 
            margin-bottom: 20px;
        }
        .adminage-messages li.success { 
            background-color: #004d40; /* Verde oscuro */
            color: #ccff90; /* Verde brillante */
            border: 1px solid #388e3c; 
        }
        .adminage-messages li.error { 
            background-color: #3b0d0d; /* Rojo oscuro */
            color: #ffcdd2; /* Rojo claro */
            border: 1px solid #d32f2f; 
        }
        .adminage-messages li.warning { 
            background-color: #5d4037; /* Naranja/Marr√≥n oscuro */
            color: #ffeb3b; /* Amarillo brillante */
            border: 1px solid #ff9800; 
        }

        /* üõ†Ô∏è CORRECCI√ìN LOCAL DEL BOX MODEL para este formulario */
        .adminage-form-container input,
        .adminage-form-container select,
        .adminage-form-container textarea {
            box-sizing: border-box; /* Fuerza la correcci√≥n del ancho localmente */
        }
        
        /* Caja de Filtros de Secci√≥n */
        .adminage-filter-box { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 30px; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 8px; 
            background-color: #212121; 
            align-items: flex-end; 
        }
        .select-group { 
            display: flex; 
            flex-direction: column; 
            flex: 1; 
        }
        .select-group label { 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: var(--text-color);
        }
        /* Ajustamos la altura del select para consistencia */
        .select-group select { 
            height: 48px; 
        }
        /* Estilos para el formulario de asignaci√≥n (campos Asignatura, Profesor) */
        .assignment-form-fields { 
            display: flex; 
            gap: 20px; 
            margin-top: 20px; 
        }
        .assignment-form-fields .form-group { 
            flex: 1; 
        }
        /* Aseguramos que los selectores dentro del form-group se vean bien */
        .assignment-form-fields select { 
            width: 100%; 
            /* Se usan los estilos de tu CSS global, solo ajustamos la altura/padding si es necesario */
            padding: 10px; 
            height: 48px; 
        }

        /* Informaci√≥n de la Secci√≥n Asignada */
        .section-info { 
            padding: 15px; 
            background-color: #282828; 
            border: 1px solid #444;
            border-radius: 5px; 
            margin-bottom: 20px; 
            font-size: 1.1rem;
        }

        /* Estilos para el campo de selecci√≥n m√∫ltiple de Trimestres */
        #id_trimesters_selected {
            height: auto !important; 
            min-height: 100px;
        }
        #id_trimesters_selected option {
            padding: 8px 10px;
        }
        
        /* Lista de Selecci√≥n Individual de Estudiantes */
        .student-list-container {
            margin-top: 15px;
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #444; 
            padding: 15px; 
            border-radius: 5px;
            background: #252525; 
        }
        .student-item { 
            margin-bottom: 8px; 
            padding: 4px 0;
        }
        .student-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .student-item input[type="checkbox"] {
            width: auto; 
            margin-right: 10px;
            cursor: pointer;
        }
        #select-all-students {
            width: auto;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="adminage-form-container">
        <h1>{{ title }}</h1>

        {% if messages %}
            <ul class="adminage-messages">
                {% for message in messages %}<li class="{{ message.tags }}">{{ message }}</li>{% endfor %}
            </ul>
        {% endif %}

        <h2>1. Seleccionar la Secci√≥n de Curso</h2>
        <p>Utilice los selectores para encontrar la secci√≥n a la que desea asignar una asignatura y un profesor.</p>

        <div class="adminage-filter-box">
            <div class="select-group">
                <label for="id_course_type">Tipo de Curso:</label>
                <select id="id_course_type">
                    <option value="">-- Seleccionar Tipo --</option>
                    {% for key, name in course_types %}
                        <option value="{{ key }}" {% if request.GET.course_type == key %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="select-group">
                <label for="id_course_level">Nivel:</label>
                <select id="id_course_level" disabled>
                    <option value="">-- Seleccionar Nivel --</option>
                </select>
            </div>

            <div class="select-group">
                <label for="id_course_section">Secci√≥n Final:</label>
                <select id="id_course_section" data-selected-id="{{ selected_course_id }}" disabled>
                    <option value="">-- Seleccionar Secci√≥n --</option>
                </select>
            </div>
        </div>

        <form method="post" id="assignment-form">
            {% csrf_token %}
            
            <input type="hidden" name="course_id" id="hidden_course_id" value="{{ selected_course_id|default:'' }}">
            <input type="hidden" name="school_year_id" value="{{ school_year_id|default:'' }}">

            <h2>2. Asignar Asignatura y Profesor</h2>

            <div class="section-info">
                Asignaci√≥n para la secci√≥n: <span id="selected-section-name" style="font-weight: bold;">
                    {% if target_course %}{{ target_course.Tipo }} {{ target_course.Section }}{% else %}(Ninguna Secci√≥n Seleccionada){% endif %}
                </span>
                {% if current_school_year %}
                    <br>A√±o Escolar: **{{ current_school_year.year }}**
                {% endif %}
            </div>

            <div class="assignment-form-fields">
                <div class="form-group">
                    {{ form.subject.label_tag }}
                    {{ form.subject }}
                    {{ form.subject.errors }}
                </div>
                <div class="form-group">
                    {{ form.teacher.label_tag }}
                    {{ form.teacher }}
                    {{ form.teacher.errors }}
                </div>
            </div>

            <div class="assignment-form-fields" style="margin-top: 15px;">
                <div class="form-group" style="flex: none; width: 100%;">
                    <label for="id_trimesters_selected">Trimestres a Asignar:</label>
                    <select name="trimesters_selected" id="id_trimesters_selected" multiple="multiple" size="{{ trimesters|length }}" required>
                        {% for trimester in trimesters %}
                            <option value="{{ trimester.pk }}">{{ trimester.Name }} ({{ trimester.school_year.year }})</option>
                        {% empty %}
                            <option value="" disabled>No hay trimestres definidos para este a√±o escolar.</option>
                        {% endfor %}
                    </select>
                    <small style="display: block; margin-top: 5px;">Mant√©n presionada la tecla Ctrl/Cmd para seleccionar varios trimestres.</small>
                </div>
            </div>
            <hr>

            <h2>3. Seleccionar Estudiantes para la Asignatura</h2>

            {% if course_students_links %}
                <p>Marque la casilla de los estudiantes que cursar√°n **esta** asignatura:</p>
                
                <div class="student-list-container">
                    <div style="margin-bottom: 10px;">
                        <input type="checkbox" id="select-all-students" checked> 
                        <label for="select-all-students" style="font-weight: bold;">Seleccionar/Deseleccionar todos</label>
                    </div>
                    {% for student_link in course_students_links %}
                        <div class="student-item">
                            <label>
                                <input type="checkbox" 
                                       name="student_links_selected" 
                                       value="{{ student_link.pk }}" 
                                       checked> 
                                {{ student_link.student.Name }} 
                                ({{ student_link.student.Email }})
                            </label>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Seleccione una secci√≥n de curso v√°lida (paso 1) para cargar la lista de estudiantes.</p>
            {% endif %}

            <button type="submit" class="submit-button" id="submit-assignment" {% if not selected_course_id %}disabled{% endif %}>
                Asignar Asignatura y Profesor
            </button>
            
            {{ form.non_field_errors }}
        </form>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            var $courseType = $('#id_course_type');
            var $courseLevel = $('#id_course_level');
            var $courseSection = $('#id_course_section');
            var $hiddenCourseId = $('#hidden_course_id');
            var $submitButton = $('#submit-assignment');
            var $sectionNameDisplay = $('#selected-section-name');
            var $selectAllStudents = $('#select-all-students');
            
            // L√≥gica para el bot√≥n Seleccionar/Deseleccionar todos
            $selectAllStudents.change(function() {
                var isChecked = $(this).prop('checked');
                $('input[name="student_links_selected"]').prop('checked', isChecked);
            });


            // üîë Obtenemos el ID del a√±o escolar y el ID del curso preseleccionado
            var schoolYearId = '{{ school_year_id|default:"" }}'; 
            var initialCourseId = $courseSection.data('selected-id'); 
            var initialCourseType = $courseType.val();
            
            // --- Funciones AJAX y de Reset ---
            
            function resetDropdowns(levelReset, sectionReset) {
                if (levelReset) {
                    $courseLevel.empty().append('<option value="">-- Seleccionar Nivel --</option>').prop('disabled', true);
                }
                if (sectionReset) {
                    $courseSection.empty().append('<option value="">-- Seleccionar Secci√≥n --</option>').prop('disabled', true);
                }
                $hiddenCourseId.val('');
                $submitButton.prop('disabled', true);
                $sectionNameDisplay.text('(Ninguna Secci√≥n Seleccionada)');
            }
            
            function loadLevels(courseType, selectedLevel) {
                resetDropdowns(true, true);
                $courseLevel.empty().append('<option value="">Cargando niveles...</option>').prop('disabled', true);

                $.ajax({
                    url: "{% url 'load_course_sections' %}",
                    data: {
                        'school_year_id': schoolYearId, 
                        'course_type': courseType
                    },
                    dataType: 'json',
                    success: function(data) {
                        $courseLevel.empty().append('<option value="">-- Seleccionar Nivel --</option>');
                        
                        if (data.mode === 'LEVELS' && data.data.length > 0) {
                            $.each(data.data, function(index, item) {
                                var option = $('<option>', {
                                    value: item.value, 
                                    text: item.text    
                                });
                                if (selectedLevel === item.value) {
                                    option.attr('selected', 'selected');
                                }
                                $courseLevel.append(option);
                            });
                            $courseLevel.prop('disabled', false);
                            
                            if (selectedLevel) {
                                loadSections(courseType, selectedLevel, initialCourseId);
                            }
                            
                        } else {
                            $courseLevel.append('<option value="">No hay niveles disponibles</option>');
                        }
                    }
                });
            }

            function loadSections(courseType, level, selectedSectionId) {
                resetDropdowns(false, true);
                $courseSection.empty().append('<option value="">Cargando secciones...</option>').prop('disabled', true);

                $.ajax({
                    url: "{% url 'load_course_sections' %}",
                    data: {
                        'school_year_id': schoolYearId, 
                        'course_type': courseType,
                        'level': level 
                    },
                    dataType: 'json',
                    success: function(data) {
                        $courseSection.empty().append('<option value="">-- Seleccionar Secci√≥n --</option>');

                        if (data.mode === 'SECTIONS' && data.data.length > 0) {
                            var sectionFound = false;
                            
                            $.each(data.data, function(index, item) {
                                var option = $('<option>', {
                                    value: item.id,   
                                    text: item.text   
                                });
                                if (selectedSectionId && selectedSectionId == item.id) {
                                    option.attr('selected', 'selected');
                                    sectionFound = true;
                                }
                                $courseSection.append(option);
                            });
                            $courseSection.prop('disabled', false);
                            
                            // Si la secci√≥n inicial fue encontrada, forzar la redirecci√≥n para cargar estudiantes
                            if (sectionFound) {
                                window.location.href = "{% url 'assign_subjects' %}?school_year_id=" + schoolYearId + "&course_id=" + selectedSectionId;
                            }
                        } else {
                            $courseSection.append('<option value="">No hay secciones disponibles</option>');
                        }
                    }
                });
            }
            
            // --- Handlers ---
            
            // 1. Evento al cambiar el Tipo de Curso
            $courseType.change(function() {
                var courseType = $(this).val();
                if (courseType && schoolYearId) {
                    loadLevels(courseType, null);
                } else {
                    resetDropdowns(true, true);
                }
            });

            // 2. Evento al cambiar el Nivel
            $courseLevel.change(function() {
                var courseType = $courseType.val();
                var level = $(this).val();
                if (level && schoolYearId) {
                    loadSections(courseType, level, null);
                } else {
                    resetDropdowns(false, true);
                }
            });
            
            // 3. Evento al cambiar la Secci√≥n Final (CR√çTICO: Redirige para cargar la lista de estudiantes)
            $courseSection.change(function() {
                var courseId = $(this).val();
                if (courseId) {
                    // üí• Redirecci√≥n: Forzar un GET para que Django cargue la lista de estudiantes
                    window.location.href = "{% url 'assign_subjects' %}?school_year_id=" + schoolYearId + "&course_id=" + courseId;
                } else {
                    // Si se deselecciona, volvemos a la vista sin course_id
                    window.location.href = "{% url 'assign_subjects' %}?school_year_id=" + schoolYearId;
                }
            });

            // 4. L√≥gica de precarga al inicio (si hay un course_id en el GET)
            if (initialCourseId && schoolYearId && initialCourseType) {
                // Hacemos una llamada AJAX para obtener el nivel de la secci√≥n seleccionada
                $.ajax({
                    url: "{% url 'load_course_sections' %}",
                    data: {
                        'school_year_id': schoolYearId,
                        'course_id_lookup': initialCourseId 
                    },
                    dataType: 'json',
                    success: function(data) {
                        if (data.mode === 'LEVEL_LOOKUP' && data.level && data.course_type) {
                            $courseType.val(data.course_type);
                            loadLevels(data.course_type, data.level); 
                        }
                    }
                });
            } else if (initialCourseType) {
                loadLevels(initialCourseType, null);
            }
        });
    </script>
</body>
</html>