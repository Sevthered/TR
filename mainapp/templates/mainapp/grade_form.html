{% extends "base.html" %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/global-styles.css' %}">
{% endblock styles %}

{% block content %}
<div class="page-root">
    <div class="page-surface" role="main">
        
        <h2>
            {% if is_edit %}
                üìù Editar Nota
            {% else %}
                ‚ûï Crear Nota para {{ student.Name }}
            {% endif %}
        </h2>

        <form method="POST">
            {% csrf_token %} 
            
            {{ form.as_p }} 

            <button type="submit" class="btn btn-success">
                {% if is_edit %}
                    Actualizar Nota
                {% else %}
                    Guardar Nota
                {% endif %}
            </button>
            <button type="button" class="btn btn-danger" onclick="window.history.back()" style="margin-left: 10px;">
                Cancelar
            </button>
        </form>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Obtenemos los selectores de los campos
        var $schoolYearSelect = $('#id_school_year');
        var $trimesterSelect = $('#id_trimester');
        var url = "{% url 'ajax_load_trimesters' %}";
        
        // Funci√≥n para cargar los trimestres v√≠a AJAX
        function loadTrimesters(schoolYearId, selectedTrimesterId) {
            $trimesterSelect.prop('disabled', true);
            
            if (!schoolYearId) {
                $trimesterSelect.html('<option value="">Seleccione un a√±o escolar</option>');
                return;
            }

            $trimesterSelect.html('<option value="">Cargando...</option>');

            $.ajax({
                url: url,
                data: {
                    'school_year_id': schoolYearId
                },
                dataType: 'json',
                // Aseg√∫rate de que la vista AJAX devuelva el n√∫mero del trimestre (1, 2, 3) en el campo 'name'.
                success: function(data) {
                    $trimesterSelect.html('<option value="">---------</option>');
                    
                    $.each(data.trimesters, function(key, trimester) {
                        var trimesterValue = trimester.id; 
                        var isSelected = (trimesterValue == selectedTrimesterId) ? 'selected' : '';
                        
                        // ‚úÖ Usa trimester.name (que ahora es 1, 2, o 3)
                        $trimesterSelect.append(
                            '<option value="' + trimesterValue + '" ' + isSelected + '>' + 'Trimestre ' + trimester.name + '</option>'
                        );
                    });
                    
                    $trimesterSelect.prop('disabled', false);
                },
                error: function() {
                    console.error("Error en la llamada AJAX a load_trimesters.");
                    $trimesterSelect.html('<option value="">Error al cargar trimestres</option>');
                }
            });
        }
        
        // --- 1. Evento de Cambio ---
        $schoolYearSelect.change(function() {
            var schoolYearId = $(this).val();
            loadTrimesters(schoolYearId, null); 
        });
        
        // --- 2. Inicializaci√≥n (al cargar la p√°gina) ---
        var initialSchoolYearId = $schoolYearSelect.val();
        
        if (initialSchoolYearId) {
            var initialTrimesterId = $trimesterSelect.val();
            loadTrimesters(initialSchoolYearId, initialTrimesterId);
        } else {
             $trimesterSelect.html('<option value="">Seleccione un a√±o escolar</option>').prop('disabled', true);
        }
    });
</script>
{% endblock scripts %}