{% extends "base.html" %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/global-styles.css' %}">
<style>
  :root {
    --surface-padding-vertical: 28px;
    --surface-padding-horizontal: 20px;
  }

  /* Este bloque de estilo es SÓLO para la maquetación (layout) del formulario de filtros.
   Heredará todos los colores (fondo, texto, bordes) de tu 'global-styles.css'.
  */
  .filter-form {
    display: flex;
    flex-wrap: wrap; /* Permite que los filtros pasen a la siguiente línea en pantallas pequeñas */
    gap: 15px; /* Espacio entre los elementos del filtro */
    align-items: flex-end; /* Alinea los <select> y el enlace 'Limpiar' por la parte inferior */
    margin-bottom: 20px;
    padding: 15px;
    /* Usamos los colores de tu CSS global */
    background-color: #1e1e1e; /* Coincide con el fondo de tu input/select */
    border: 1px solid #444; /* Coincide con el borde de tu input/select */
    border-radius: 8px;
  }
  .filter-form .form-group {
    display: flex;
    flex-direction: column;
  }
  .filter-form label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--muted-color); /* Usa tu variable de color 'muted' */
  }

  /* Sobrescribe el 'width: 100%' de tu CSS global SÓLO dentro del .filter-form 
   para que los desplegables quepan uno al lado del otro.
  */
  .filter-form select {
    width: auto; /* Permite que el select tome su ancho natural */
    min-width: 200px; /* Un ancho mínimo para que no se vea mal */
    margin-bottom: 0; /* Anula el margen global dentro de este formulario */
  }

  /* Ajusta la alineación vertical del enlace 'Limpiar' */
  .filter-form a {
    margin-bottom: 8px; 
  }
</style>
{% endblock styles %}

{% block content %}
<div class="page-root">
    <div class="page-surface" role="main" aria-labelledby="student-name">
        {% if user.is_authenticated and user.profile.role == 'professor' %}
        <p>
            {% if return_course %}
                <button type="button" class="btn-back" onclick="window.history.back()">← Volver</button>
            {% else %}
                <button type="button" class="btn-back" onclick="window.history.back()">← Volver</button>
            {% endif %}
        </p>
        {% endif %}
        <h2 id="student-name">
            {{ student.Name }}
        </h2>
        <p><strong>Email:</strong> {{ student.Email }}</p>
        
        <form method="get" action="" class="filter-form">
            
            <div class="form-group">
                <label for="id_school_year">Año Escolar:</label>
                <select name="school_year_id" id="id_school_year" onchange="this.form.submit()">
                    <option value="">-- Todos los Años --</option>
                    {% for year in all_school_years %}
                        <option value="{{ year.pk }}" {% if year.pk == selected_year_id %}selected{% endif %}>
                            {{ year.year }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="id_trimester">Trimestre:</label>
                <select name="trimester_id" id="id_trimester" onchange="this.form.submit()" {% if not selected_year_id %}disabled{% endif %}>
                    <option value="">-- Todos los Trimestres --</option>
                    {% for trimester in available_trimesters %}
                        <option value="{{ trimester.pk }}" {% if trimester.pk == selected_trimester_id %}selected{% endif %}>
                            Trimestre {{ trimester.Name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <a href="?">Limpiar Filtros</a>
        </form>
        <h2>Notas</h2>
                {% if user.is_authenticated and user.profile.role == 'professor' %}
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-success" onclick="window.location.href='{% url 'grade_create' student_id=student.pk %}'">
                        Crear Notas
                    </button>
                    <button type="button" class="btn btn-primary" 
                            onclick="window.location.href='{% url 'grades_csv_student' student_id=student.pk %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}'" 
                            style="margin-left: 10px;">
                        Descargar Notas CSV
                    </button>
                </div>
                {% elif user.is_authenticated and user.profile.role == 'student' %}
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-primary" 
                            onclick="window.location.href='{% url 'grades_csv' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}'">
                        Descargar Mis Notas CSV
                    </button>
                </div>
                {% elif user.is_authenticated and user.profile.role == 'tutor' %}
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-primary" 
                            onclick="window.location.href='{% url 'grades_csv' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}'">
                        Descargar Notas de Mis Hijos CSV
                    </button>
                </div>
                {% endif %}
                <div class="table-wrap">
                    <table class="table student-table" aria-describedby="grades-note">
            <thead>
                <tr>
                    <th>Trimestre</th>
                    <th>Nota</th>
                    <th>Asignatura</th>
                    <th>Comentario</th>
                    {% if user.is_authenticated and user.profile.role == 'professor' %}
                    <th>Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for grade in grades %}
                        <tr>
                            <td>{{ grade.trimester.Name|default:"N/A" }}</td>
                            <td class="{% if grade.grade < 5 %}grade-fail{% endif %}">
                                {{ grade.grade }}
                            </td>
                            <td>{{ grade.subject.Name|default:"N/A" }}</td>
                            <td class="comment-cell">
                                {{ grade.comments|default:"No hay comentario" }}
                            </td>
                            {% if user.is_authenticated and user.profile.role == 'professor' %}
                            <td>
                                <button type="button" class="btn-edit" onclick="window.location.href='{% url 'grade_edit' grade_id=grade.id %}'">Edit</button>
                            </td>
                            {% endif %}    
                        </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" id="grades-note">No hay notas disponibles para los filtros seleccionados.</td>
                    </tr>
                {% endfor %}
            </tbody>
                    </table>
                </div>

                <h2>Ausencias</h2>
                {% if user.is_authenticated and user.profile.role == 'professor' %}
                <button type="button" class="btn btn-success" onclick="window.location.href='{% url 'ausencia_create' student_id=student.pk %}'">
                    Crear Ausencia
                </button>
                <br>
                <br>
                {% endif %}
                <div class="table-wrap">
                    <table class="table student-table" aria-describedby="absences-note">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Materia</th>
                    <th>Profesor</th>
                    <th>Tipo</th>
                    {% if user.is_authenticated and user.profile.role == 'professor' %}
                    <th>Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for ausencia in ausencias %}
                    <tr>
                        <td>{{ ausencia.date_time }}</td>
                        <td>{{ ausencia.subject }}</td>
                        <td>{{ ausencia.teacher }}</td>
                        <td class="{% if ausencia.Tipo == 'Retraso' %}absence-delay{% elif ausencia.Tipo == 'Ausencia' %}absence-absence{% endif %}">
                            {{ ausencia.Tipo }}
                        </td>
                        {% if user.is_authenticated and user.profile.role == 'professor' %}
                        <td>
                            <button type="button" class="btn-edit" onclick="window.location.href='{% url 'ausencia_edit' ausencia_id=ausencia.id %}'">Edit</button>
                        </td>
                        {% endif %}
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" id="absences-note">No hay ausencias registradas para los filtros seleccionados.</td>
                    </tr>
                {% endfor %}
            </tbody>
                    </table>
                </div>
    </div>
</div>

{% endblock content %}